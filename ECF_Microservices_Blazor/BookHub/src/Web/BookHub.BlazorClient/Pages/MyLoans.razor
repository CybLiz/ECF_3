@page "/my-loans"
@using BookHub.Shared.DTOs
@inject ILoanService LoanService
@inject AuthStateProvider AuthState

<PageTitle>Mes Emprunts - BookHub</PageTitle>

<h1>Mes Emprunts</h1>

<h3>Emprunts en cours</h3>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary"></div>
    </div>
}
else if (activeLoans == null || !activeLoans.Any())
{
    <div class="alert alert-info">Aucun emprunt en cours.</div>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Livre</th>
                <th>Date d'emprunt</th>
                <th>Date de retour</th>
                <th>Statut</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var loan in activeLoans)
            {
                <tr>
                    <td>@loan.BookTitle</td>
                    <td>@loan.LoanDate.ToShortDateString()</td>
                    <td>@loan.DueDate.ToShortDateString()</td>
                    <td>@loan.Status</td>
                    <td>
                        <button class="btn btn-sm btn-primary"
                                @onclick="() => ReturnLoan(loan)">
                            Retourner
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<h3>Historique des emprunts</h3>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary"></div>
    </div>
}
else if (pastLoans == null || !pastLoans.Any())
{
    <div class="alert alert-info">Aucun emprunt passé.</div>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Livre</th>
                <th>Date d'emprunt</th>
                <th>Date de retour</th>
                <th>Statut</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var loan in pastLoans)
            {
                <tr>
                    <td>@loan.BookTitle</td>
                    <td>@loan.LoanDate.ToShortDateString()</td>
                    <td>@loan.ReturnDate?.ToShortDateString()</td>
                    <td>@loan.Status</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private bool isLoading;
    private List<LoanDto> loans = new();
    private List<LoanDto> activeLoans = new();
    private List<LoanDto> pastLoans = new();

    protected override async Task OnInitializedAsync()
    {
        if (!AuthState.IsAuthenticated)
            return;

        await LoadLoans();
    }

    private async Task LoadLoans()
    {
        isLoading = true;

        try
        {
            var userId = AuthState.CurrentUser!.Id;
            loans = (await LoanService.GetUserLoansAsync(userId)).ToList();

            activeLoans = loans
                .Where(l => l.Status == BookHub.Shared.DTOs.LoanStatus.Active)
                .ToList();

            pastLoans = loans
                .Where(l => l.Status == BookHub.Shared.DTOs.LoanStatus.Returned)
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur chargement emprunts : {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ReturnLoan(LoanDto loan)
{
    try
    {
        var returnedLoan = await LoanService.ReturnLoanAsync(loan.Id);

        if (returnedLoan != null)
        {
            activeLoans.Remove(loan);
            pastLoans.Add(returnedLoan);
        }
            await LoadLoans();

    }
    catch (Exception ex)
    {
        Console.WriteLine($"Erreur retour : {ex.Message}");
    }

}

}
