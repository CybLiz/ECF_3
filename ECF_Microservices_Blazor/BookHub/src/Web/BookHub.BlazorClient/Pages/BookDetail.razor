@page "/books/{Id:guid}"
@inject IBookService BookService
@inject ILoanService LoanService
@inject AuthStateProvider AuthState
@inject NavigationManager NavigationManager

<PageTitle>Détail du livre - BookHub</PageTitle>

<a href="/books" class="btn btn-secondary mb-3">
    <i class="bi bi-arrow-left"></i> Retour au catalogue
</a>

@if (book == null)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary"></div>
    </div>
}
else
{
    <BookDetailsCard 
        Book="book"
        OnBorrow="() => showConfirmationModal = true" />

    <ConfirmationModal 
        Title="Emprunter ce livre ?"
        Message="Voulez-vous vraiment emprunter ce livre ?"
        OnConfirmed="BorrowBook"
        @bind-IsVisible="showConfirmationModal" />
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private BookDto? book;
    private bool showConfirmationModal = false;

    protected override async Task OnInitializedAsync()
    {
        book = await BookService.GetBookByIdAsync(Id);
    }

    private async Task BorrowBook()
    {
        if (book == null || !AuthState.IsAuthenticated)
        {
            Console.WriteLine("Impossible d'emprunter : utilisateur non authentifié ou livre inexistant");
            return;
        }

        var createLoan = new CreateLoanDto(
            UserId: AuthState.CurrentUser!.Id,
            BookId: book.Id
        );

        try
        {
            var loan = await LoanService.CreateLoanAsync(createLoan);
            Console.WriteLine($"Emprunt créé pour {book.Title} (Loan ID: {loan.Id})");

            // Redirection vers Mes Emprunts
            NavigationManager.NavigateTo("/my-loans");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de l'emprunt : {ex.Message}");
        }
    }
}
